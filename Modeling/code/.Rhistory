mutate(onsetCoef_range2 = onset.1 + 1.96*onset_se) %>%
mutate(onset_signif = !(onsetCoef_range1 < 0 & onsetCoef_range2 > 0))
# get only rows with statistically significant onset coefficients
gwr.df.signif <- gwr.df %>% subset(onset_signif == TRUE)
# create tmap objects
# map_localR2 <- tm_shape(gwr.map) +
#   tm_fill("localR2", n = 5, style = "quantile") +
#   tm_layout(title = paste("Local R2,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# put in only statistically significant coefficients
map_onset <-   tm_shape(MT_outline) +
tm_polygons(alpha = 0) +
tm_shape(gwr.map.signif) +
tm_fill("onset.1", breaks = seq(-4, 4)) +
tm_layout(title = paste("Onset Coefficient (stat signif),", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# map_intensity <- tm_shape(gwr.map) +
#   tm_fill("intensitySC", n = 5, style = "quantile") +
#   tm_layout(title = paste("IntensitySC Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
#
# map_latitude <- tm_shape(gwr.map) +
#   tm_fill("lat.1", n = 5, style = "quantile") +
#   tm_layout(title = paste("Latitude Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# map_onset_se <- tm_shape(gwr.map) +
#   tm_fill("onset_se", n = 5, style = "quantile") +
#   tm_layout(title = paste("Onset Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# map_intensity_se <- tm_shape(gwr.map) +
#   tm_fill("intensitySC_se", n = 5, style = "quantile") +
#   tm_layout(title = paste("IntensitySC Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
#
# map_latitude_se <- tm_shape(gwr.map) +
#   tm_fill("lat_se", n = 5, style = "quantile") +
#   tm_layout(title = paste("Latitude Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
#
# map_localR2
# map_intensity
# map_latitude
# map_intensity_se
# map_latitude_se
onset_deviation1_plot <- ggplot(gwr.df, aes(x = onset_deviation1, y = onset.1, col = onset_signif)) +
geom_point(alpha = 0.3) +
ggtitle(paste("Stat signif cells in", year_oi)) +
xlab("onset deviation from within-cell multiyear median") +
ylab("onset coefficient") +
geom_smooth(method = "lm") +
geom_vline(xintercept = 0) +
coord_cartesian(ylim = c(-3, 3), xlim = c(-30, 40)) +
theme_bw()
onset_deviation2_plot <- ggplot(gwr.df, aes(x = onset_deviation2, y = onset.1, col = onset_signif)) +
geom_point(alpha = 0.3) +
ggtitle(paste("Stat signif cells in", year_oi)) +
xlab("onset deviation from multiyear, multicell median") +
ylab("onset coefficient") +
geom_smooth(method = "lm") +
geom_vline(xintercept = 0) +
coord_cartesian(ylim = c(-3, 3), xlim = c(-50, 40)) +
theme_bw()
# print plots
#print(map_onset)
#print(map_onset_se)
#print(onset_deviation2_plot)
percent_pos_onset <- sum(gwr.df.signif$onset_deviation2 > 0)/length(gwr.df.signif$onset_deviation2)
percent_pos_coef <- sum(gwr.df.signif$onset.1 > 0)/length(gwr.df.signif$onset_deviation2)
print(c('year', year_oi))
print(c('percent positive onset deviation', percent_pos_onset))
print(c('percent positive onset coef', percent_pos_coef))
print(map_onset)
map_onset
library(spgwr) # spatially weighted regression
year_oi <- 2011
# need to read in again because we re-save it at the end
cell_sf <- st_read(dsn = 'E:/R-code/Modeling/data/shp/median_onset_cell', layer = 'median_onset_cell_SHP')
cell_sf_tidy <- cell_sf %>% tidy_by_intensity_plant("SC_plant", "DC_plant") %>%
tidy_by_intensity_delay("SC_delay", "DC_delay") %>%
dplyr::select(-c(SC_harvest, DC_harvest))
cell_sf_tidy$year_index <- cell_sf_tidy$year - 2003
# filter for a specific year, then turn sf object into SPDF
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
cell_spdf_tidy_year <- as(cell_sf_tidy_year, 'Spatial')
#run GWR
#calculate kernel bandwidth (takes a long time)
GWRbandwidth <- gwr.sel(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt =TRUE)
#run the gwr model
gwr.model <- gwr(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt=GWRbandwidth, hatmatrix=TRUE, se.fit=TRUE)
#print the results of the model
gwr.model
# calculate median onset over the years for each cell, then the deviation from the median in that year
cell_sf_tidy <- cell_sf_tidy %>%
group_by(label) %>%
mutate(onset_multiYearMedian = median(onset)) %>% # over all time, but for specific cell
mutate(onset_deviation1 = onset - onset_multiYearMedian) %>%
ungroup() %>%
mutate(onset_overallMedian = median(onset)) %>% # over all space and time
mutate(onset_deviation2 = onset - onset_overallMedian)
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
# third, map the results
results <-as.data.frame(gwr.model$SDF)
gwr.map <- cbind(cell_spdf_tidy_year, as.matrix(results))
gwr.map$onset_deviation1 <- cell_sf_tidy_year$onset_deviation1 # deviation from multiyear median onset compared to specific cell
gwr.map$onset_deviation2 <- cell_sf_tidy_year$onset_deviation2 # deviation from multiyear median onset over all space
# as spdf
gwr.map$onsetCoef_range1 <- gwr.map$onset.1 - 1.96*gwr.map$onset_se
gwr.map$onsetCoef_range2 <- gwr.map$onset.1 + 1.96*gwr.map$onset_se
gwr.map$onset_signif <- !(gwr.map$onsetCoef_range1 < 0 & gwr.map$onsetCoef_range2 > 0)
# get only the cells with statistically significant onset coefficients
gwr.map.signif <- gwr.map[gwr.map$onset_signif == TRUE,]
# as data frame
gwr.df <- as.data.frame(gwr.map)
gwr.df <- gwr.df %>%
mutate(onsetCoef_range1 = onset.1 - 1.96*onset_se) %>%
mutate(onsetCoef_range2 = onset.1 + 1.96*onset_se) %>%
mutate(onset_signif = !(onsetCoef_range1 < 0 & onsetCoef_range2 > 0))
# get only rows with statistically significant onset coefficients
gwr.df.signif <- gwr.df %>% subset(onset_signif == TRUE)
# create tmap objects
# map_localR2 <- tm_shape(gwr.map) +
#   tm_fill("localR2", n = 5, style = "quantile") +
#   tm_layout(title = paste("Local R2,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# put in only statistically significant coefficients
map_onset <-   tm_shape(MT_outline) +
tm_polygons(alpha = 0) +
tm_shape(gwr.map.signif) +
tm_fill("onset.1", breaks = seq(-4, 4)) +
tm_layout(title = paste("Onset Coefficient (stat signif),", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# map_intensity <- tm_shape(gwr.map) +
#   tm_fill("intensitySC", n = 5, style = "quantile") +
#   tm_layout(title = paste("IntensitySC Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
#
# map_latitude <- tm_shape(gwr.map) +
#   tm_fill("lat.1", n = 5, style = "quantile") +
#   tm_layout(title = paste("Latitude Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# map_onset_se <- tm_shape(gwr.map) +
#   tm_fill("onset_se", n = 5, style = "quantile") +
#   tm_layout(title = paste("Onset Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# map_intensity_se <- tm_shape(gwr.map) +
#   tm_fill("intensitySC_se", n = 5, style = "quantile") +
#   tm_layout(title = paste("IntensitySC Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
#
# map_latitude_se <- tm_shape(gwr.map) +
#   tm_fill("lat_se", n = 5, style = "quantile") +
#   tm_layout(title = paste("Latitude Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
#
# map_localR2
# map_intensity
# map_latitude
# map_intensity_se
# map_latitude_se
onset_deviation1_plot <- ggplot(gwr.df, aes(x = onset_deviation1, y = onset.1, col = onset_signif)) +
geom_point(alpha = 0.3) +
ggtitle(paste("Stat signif cells in", year_oi)) +
xlab("onset deviation from within-cell multiyear median") +
ylab("onset coefficient") +
geom_smooth(method = "lm") +
geom_vline(xintercept = 0) +
coord_cartesian(ylim = c(-3, 3), xlim = c(-30, 40)) +
theme_bw()
onset_deviation2_plot <- ggplot(gwr.df, aes(x = onset_deviation2, y = onset.1, col = onset_signif)) +
geom_point(alpha = 0.3) +
ggtitle(paste("Stat signif cells in", year_oi)) +
xlab("onset deviation from multiyear, multicell median") +
ylab("onset coefficient") +
geom_smooth(method = "lm") +
geom_vline(xintercept = 0) +
coord_cartesian(ylim = c(-3, 3), xlim = c(-50, 40)) +
theme_bw()
# print plots
#print(map_onset)
#print(map_onset_se)
#print(onset_deviation2_plot)
percent_pos_onset <- sum(gwr.df.signif$onset_deviation2 > 0)/length(gwr.df.signif$onset_deviation2)
percent_pos_coef <- sum(gwr.df.signif$onset.1 > 0)/length(gwr.df.signif$onset_deviation2)
print(c('year', year_oi))
print(c('percent positive onset deviation', percent_pos_onset))
print(c('percent positive onset coef', percent_pos_coef))
print(map_onset)
map_onset
library(spgwr) # spatially weighted regression
year_oi <- 2012
# need to read in again because we re-save it at the end
cell_sf <- st_read(dsn = 'E:/R-code/Modeling/data/shp/median_onset_cell', layer = 'median_onset_cell_SHP')
cell_sf_tidy <- cell_sf %>% tidy_by_intensity_plant("SC_plant", "DC_plant") %>%
tidy_by_intensity_delay("SC_delay", "DC_delay") %>%
dplyr::select(-c(SC_harvest, DC_harvest))
cell_sf_tidy$year_index <- cell_sf_tidy$year - 2003
# filter for a specific year, then turn sf object into SPDF
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
cell_spdf_tidy_year <- as(cell_sf_tidy_year, 'Spatial')
#run GWR
#calculate kernel bandwidth (takes a long time)
GWRbandwidth <- gwr.sel(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt =TRUE)
#run the gwr model
gwr.model <- gwr(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt=GWRbandwidth, hatmatrix=TRUE, se.fit=TRUE)
#print the results of the model
gwr.model
# calculate median onset over the years for each cell, then the deviation from the median in that year
cell_sf_tidy <- cell_sf_tidy %>%
group_by(label) %>%
mutate(onset_multiYearMedian = median(onset)) %>% # over all time, but for specific cell
mutate(onset_deviation1 = onset - onset_multiYearMedian) %>%
ungroup() %>%
mutate(onset_overallMedian = median(onset)) %>% # over all space and time
mutate(onset_deviation2 = onset - onset_overallMedian)
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
# third, map the results
results <-as.data.frame(gwr.model$SDF)
gwr.map <- cbind(cell_spdf_tidy_year, as.matrix(results))
gwr.map$onset_deviation1 <- cell_sf_tidy_year$onset_deviation1 # deviation from multiyear median onset compared to specific cell
gwr.map$onset_deviation2 <- cell_sf_tidy_year$onset_deviation2 # deviation from multiyear median onset over all space
# as spdf
gwr.map$onsetCoef_range1 <- gwr.map$onset.1 - 1.96*gwr.map$onset_se
gwr.map$onsetCoef_range2 <- gwr.map$onset.1 + 1.96*gwr.map$onset_se
gwr.map$onset_signif <- !(gwr.map$onsetCoef_range1 < 0 & gwr.map$onsetCoef_range2 > 0)
# get only the cells with statistically significant onset coefficients
gwr.map.signif <- gwr.map[gwr.map$onset_signif == TRUE,]
# as data frame
gwr.df <- as.data.frame(gwr.map)
gwr.df <- gwr.df %>%
mutate(onsetCoef_range1 = onset.1 - 1.96*onset_se) %>%
mutate(onsetCoef_range2 = onset.1 + 1.96*onset_se) %>%
mutate(onset_signif = !(onsetCoef_range1 < 0 & onsetCoef_range2 > 0))
# get only rows with statistically significant onset coefficients
gwr.df.signif <- gwr.df %>% subset(onset_signif == TRUE)
# create tmap objects
# map_localR2 <- tm_shape(gwr.map) +
#   tm_fill("localR2", n = 5, style = "quantile") +
#   tm_layout(title = paste("Local R2,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# put in only statistically significant coefficients
map_onset <-   tm_shape(MT_outline) +
tm_polygons(alpha = 0) +
tm_shape(gwr.map.signif) +
tm_fill("onset.1", breaks = seq(-4, 4)) +
tm_layout(title = paste("Onset Coefficient (stat signif),", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# map_intensity <- tm_shape(gwr.map) +
#   tm_fill("intensitySC", n = 5, style = "quantile") +
#   tm_layout(title = paste("IntensitySC Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
#
# map_latitude <- tm_shape(gwr.map) +
#   tm_fill("lat.1", n = 5, style = "quantile") +
#   tm_layout(title = paste("Latitude Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# map_onset_se <- tm_shape(gwr.map) +
#   tm_fill("onset_se", n = 5, style = "quantile") +
#   tm_layout(title = paste("Onset Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# map_intensity_se <- tm_shape(gwr.map) +
#   tm_fill("intensitySC_se", n = 5, style = "quantile") +
#   tm_layout(title = paste("IntensitySC Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
#
# map_latitude_se <- tm_shape(gwr.map) +
#   tm_fill("lat_se", n = 5, style = "quantile") +
#   tm_layout(title = paste("Latitude Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
#
# map_localR2
# map_intensity
# map_latitude
# map_intensity_se
# map_latitude_se
onset_deviation1_plot <- ggplot(gwr.df, aes(x = onset_deviation1, y = onset.1, col = onset_signif)) +
geom_point(alpha = 0.3) +
ggtitle(paste("Stat signif cells in", year_oi)) +
xlab("onset deviation from within-cell multiyear median") +
ylab("onset coefficient") +
geom_smooth(method = "lm") +
geom_vline(xintercept = 0) +
coord_cartesian(ylim = c(-3, 3), xlim = c(-30, 40)) +
theme_bw()
onset_deviation2_plot <- ggplot(gwr.df, aes(x = onset_deviation2, y = onset.1, col = onset_signif)) +
geom_point(alpha = 0.3) +
ggtitle(paste("Stat signif cells in", year_oi)) +
xlab("onset deviation from multiyear, multicell median") +
ylab("onset coefficient") +
geom_smooth(method = "lm") +
geom_vline(xintercept = 0) +
coord_cartesian(ylim = c(-3, 3), xlim = c(-50, 40)) +
theme_bw()
# print plots
#print(map_onset)
#print(map_onset_se)
#print(onset_deviation2_plot)
percent_pos_onset <- sum(gwr.df.signif$onset_deviation2 > 0)/length(gwr.df.signif$onset_deviation2)
percent_pos_coef <- sum(gwr.df.signif$onset.1 > 0)/length(gwr.df.signif$onset_deviation2)
print(c('year', year_oi))
print(c('percent positive onset deviation', percent_pos_onset))
print(c('percent positive onset coef', percent_pos_coef))
print(map_onset)
map_onset
library(spgwr) # spatially weighted regression
year_oi <- 2013
# need to read in again because we re-save it at the end
cell_sf <- st_read(dsn = 'E:/R-code/Modeling/data/shp/median_onset_cell', layer = 'median_onset_cell_SHP')
cell_sf_tidy <- cell_sf %>% tidy_by_intensity_plant("SC_plant", "DC_plant") %>%
tidy_by_intensity_delay("SC_delay", "DC_delay") %>%
dplyr::select(-c(SC_harvest, DC_harvest))
cell_sf_tidy$year_index <- cell_sf_tidy$year - 2003
# filter for a specific year, then turn sf object into SPDF
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
cell_spdf_tidy_year <- as(cell_sf_tidy_year, 'Spatial')
#run GWR
#calculate kernel bandwidth (takes a long time)
GWRbandwidth <- gwr.sel(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt =TRUE)
#run the gwr model
gwr.model <- gwr(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt=GWRbandwidth, hatmatrix=TRUE, se.fit=TRUE)
#print the results of the model
gwr.model
# calculate median onset over the years for each cell, then the deviation from the median in that year
cell_sf_tidy <- cell_sf_tidy %>%
group_by(label) %>%
mutate(onset_multiYearMedian = median(onset)) %>% # over all time, but for specific cell
mutate(onset_deviation1 = onset - onset_multiYearMedian) %>%
ungroup() %>%
mutate(onset_overallMedian = median(onset)) %>% # over all space and time
mutate(onset_deviation2 = onset - onset_overallMedian)
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
# third, map the results
results <-as.data.frame(gwr.model$SDF)
gwr.map <- cbind(cell_spdf_tidy_year, as.matrix(results))
gwr.map$onset_deviation1 <- cell_sf_tidy_year$onset_deviation1 # deviation from multiyear median onset compared to specific cell
gwr.map$onset_deviation2 <- cell_sf_tidy_year$onset_deviation2 # deviation from multiyear median onset over all space
# as spdf
gwr.map$onsetCoef_range1 <- gwr.map$onset.1 - 1.96*gwr.map$onset_se
gwr.map$onsetCoef_range2 <- gwr.map$onset.1 + 1.96*gwr.map$onset_se
gwr.map$onset_signif <- !(gwr.map$onsetCoef_range1 < 0 & gwr.map$onsetCoef_range2 > 0)
# get only the cells with statistically significant onset coefficients
gwr.map.signif <- gwr.map[gwr.map$onset_signif == TRUE,]
# as data frame
gwr.df <- as.data.frame(gwr.map)
gwr.df <- gwr.df %>%
mutate(onsetCoef_range1 = onset.1 - 1.96*onset_se) %>%
mutate(onsetCoef_range2 = onset.1 + 1.96*onset_se) %>%
mutate(onset_signif = !(onsetCoef_range1 < 0 & onsetCoef_range2 > 0))
# get only rows with statistically significant onset coefficients
gwr.df.signif <- gwr.df %>% subset(onset_signif == TRUE)
# create tmap objects
# map_localR2 <- tm_shape(gwr.map) +
#   tm_fill("localR2", n = 5, style = "quantile") +
#   tm_layout(title = paste("Local R2,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# put in only statistically significant coefficients
map_onset <-   tm_shape(MT_outline) +
tm_polygons(alpha = 0) +
tm_shape(gwr.map.signif) +
tm_fill("onset.1", breaks = seq(-4, 4)) +
tm_layout(title = paste("Onset Coefficient (stat signif),", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# map_intensity <- tm_shape(gwr.map) +
#   tm_fill("intensitySC", n = 5, style = "quantile") +
#   tm_layout(title = paste("IntensitySC Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
#
# map_latitude <- tm_shape(gwr.map) +
#   tm_fill("lat.1", n = 5, style = "quantile") +
#   tm_layout(title = paste("Latitude Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# map_onset_se <- tm_shape(gwr.map) +
#   tm_fill("onset_se", n = 5, style = "quantile") +
#   tm_layout(title = paste("Onset Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# map_intensity_se <- tm_shape(gwr.map) +
#   tm_fill("intensitySC_se", n = 5, style = "quantile") +
#   tm_layout(title = paste("IntensitySC Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
#
# map_latitude_se <- tm_shape(gwr.map) +
#   tm_fill("lat_se", n = 5, style = "quantile") +
#   tm_layout(title = paste("Latitude Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
#
# map_localR2
# map_intensity
# map_latitude
# map_intensity_se
# map_latitude_se
onset_deviation1_plot <- ggplot(gwr.df, aes(x = onset_deviation1, y = onset.1, col = onset_signif)) +
geom_point(alpha = 0.3) +
ggtitle(paste("Stat signif cells in", year_oi)) +
xlab("onset deviation from within-cell multiyear median") +
ylab("onset coefficient") +
geom_smooth(method = "lm") +
geom_vline(xintercept = 0) +
coord_cartesian(ylim = c(-3, 3), xlim = c(-30, 40)) +
theme_bw()
onset_deviation2_plot <- ggplot(gwr.df, aes(x = onset_deviation2, y = onset.1, col = onset_signif)) +
geom_point(alpha = 0.3) +
ggtitle(paste("Stat signif cells in", year_oi)) +
xlab("onset deviation from multiyear, multicell median") +
ylab("onset coefficient") +
geom_smooth(method = "lm") +
geom_vline(xintercept = 0) +
coord_cartesian(ylim = c(-3, 3), xlim = c(-50, 40)) +
theme_bw()
# print plots
#print(map_onset)
#print(map_onset_se)
#print(onset_deviation2_plot)
percent_pos_onset <- sum(gwr.df.signif$onset_deviation2 > 0)/length(gwr.df.signif$onset_deviation2)
percent_pos_coef <- sum(gwr.df.signif$onset.1 > 0)/length(gwr.df.signif$onset_deviation2)
print(c('year', year_oi))
print(c('percent positive onset deviation', percent_pos_onset))
print(c('percent positive onset coef', percent_pos_coef))
print(map_onset)
map_onset
library(spgwr) # spatially weighted regression
year_oi <- 2014
# need to read in again because we re-save it at the end
cell_sf <- st_read(dsn = 'E:/R-code/Modeling/data/shp/median_onset_cell', layer = 'median_onset_cell_SHP')
cell_sf_tidy <- cell_sf %>% tidy_by_intensity_plant("SC_plant", "DC_plant") %>%
tidy_by_intensity_delay("SC_delay", "DC_delay") %>%
dplyr::select(-c(SC_harvest, DC_harvest))
cell_sf_tidy$year_index <- cell_sf_tidy$year - 2003
# filter for a specific year, then turn sf object into SPDF
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
cell_spdf_tidy_year <- as(cell_sf_tidy_year, 'Spatial')
#run GWR
#calculate kernel bandwidth (takes a long time)
GWRbandwidth <- gwr.sel(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt =TRUE)
#run the gwr model
gwr.model <- gwr(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt=GWRbandwidth, hatmatrix=TRUE, se.fit=TRUE)
#print the results of the model
gwr.model
# calculate median onset over the years for each cell, then the deviation from the median in that year
cell_sf_tidy <- cell_sf_tidy %>%
group_by(label) %>%
mutate(onset_multiYearMedian = median(onset)) %>% # over all time, but for specific cell
mutate(onset_deviation1 = onset - onset_multiYearMedian) %>%
ungroup() %>%
mutate(onset_overallMedian = median(onset)) %>% # over all space and time
mutate(onset_deviation2 = onset - onset_overallMedian)
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
# third, map the results
results <-as.data.frame(gwr.model$SDF)
gwr.map <- cbind(cell_spdf_tidy_year, as.matrix(results))
gwr.map$onset_deviation1 <- cell_sf_tidy_year$onset_deviation1 # deviation from multiyear median onset compared to specific cell
gwr.map$onset_deviation2 <- cell_sf_tidy_year$onset_deviation2 # deviation from multiyear median onset over all space
# as spdf
gwr.map$onsetCoef_range1 <- gwr.map$onset.1 - 1.96*gwr.map$onset_se
gwr.map$onsetCoef_range2 <- gwr.map$onset.1 + 1.96*gwr.map$onset_se
gwr.map$onset_signif <- !(gwr.map$onsetCoef_range1 < 0 & gwr.map$onsetCoef_range2 > 0)
# get only the cells with statistically significant onset coefficients
gwr.map.signif <- gwr.map[gwr.map$onset_signif == TRUE,]
# as data frame
gwr.df <- as.data.frame(gwr.map)
gwr.df <- gwr.df %>%
mutate(onsetCoef_range1 = onset.1 - 1.96*onset_se) %>%
mutate(onsetCoef_range2 = onset.1 + 1.96*onset_se) %>%
mutate(onset_signif = !(onsetCoef_range1 < 0 & onsetCoef_range2 > 0))
# get only rows with statistically significant onset coefficients
gwr.df.signif <- gwr.df %>% subset(onset_signif == TRUE)
# create tmap objects
# map_localR2 <- tm_shape(gwr.map) +
#   tm_fill("localR2", n = 5, style = "quantile") +
#   tm_layout(title = paste("Local R2,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# put in only statistically significant coefficients
map_onset <-   tm_shape(MT_outline) +
tm_polygons(alpha = 0) +
tm_shape(gwr.map.signif) +
tm_fill("onset.1", breaks = seq(-4, 4)) +
tm_layout(title = paste("Onset Coefficient (stat signif),", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# map_intensity <- tm_shape(gwr.map) +
#   tm_fill("intensitySC", n = 5, style = "quantile") +
#   tm_layout(title = paste("IntensitySC Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
#
# map_latitude <- tm_shape(gwr.map) +
#   tm_fill("lat.1", n = 5, style = "quantile") +
#   tm_layout(title = paste("Latitude Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# map_onset_se <- tm_shape(gwr.map) +
#   tm_fill("onset_se", n = 5, style = "quantile") +
#   tm_layout(title = paste("Onset Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
# map_intensity_se <- tm_shape(gwr.map) +
#   tm_fill("intensitySC_se", n = 5, style = "quantile") +
#   tm_layout(title = paste("IntensitySC Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
#
# map_latitude_se <- tm_shape(gwr.map) +
#   tm_fill("lat_se", n = 5, style = "quantile") +
#   tm_layout(title = paste("Latitude Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
#
# map_localR2
# map_intensity
# map_latitude
# map_intensity_se
# map_latitude_se
onset_deviation1_plot <- ggplot(gwr.df, aes(x = onset_deviation1, y = onset.1, col = onset_signif)) +
geom_point(alpha = 0.3) +
ggtitle(paste("Stat signif cells in", year_oi)) +
xlab("onset deviation from within-cell multiyear median") +
ylab("onset coefficient") +
geom_smooth(method = "lm") +
geom_vline(xintercept = 0) +
coord_cartesian(ylim = c(-3, 3), xlim = c(-30, 40)) +
theme_bw()
onset_deviation2_plot <- ggplot(gwr.df, aes(x = onset_deviation2, y = onset.1, col = onset_signif)) +
geom_point(alpha = 0.3) +
ggtitle(paste("Stat signif cells in", year_oi)) +
xlab("onset deviation from multiyear, multicell median") +
ylab("onset coefficient") +
geom_smooth(method = "lm") +
geom_vline(xintercept = 0) +
coord_cartesian(ylim = c(-3, 3), xlim = c(-50, 40)) +
theme_bw()
# print plots
#print(map_onset)
#print(map_onset_se)
#print(onset_deviation2_plot)
percent_pos_onset <- sum(gwr.df.signif$onset_deviation2 > 0)/length(gwr.df.signif$onset_deviation2)
percent_pos_coef <- sum(gwr.df.signif$onset.1 > 0)/length(gwr.df.signif$onset_deviation2)
print(c('year', year_oi))
print(c('percent positive onset deviation', percent_pos_onset))
print(c('percent positive onset coef', percent_pos_coef))
print(map_onset)
map_onset
par.cov
SpatioTemporalfit1$res.best
