percentile5_cell_raw <- read.csv('E:/R-code/Modeling/data/percentile5_onset_cell_v2.csv')
percentile95_cell_raw <- read.csv('E:/R-code/Modeling/data/percentile95_onset_cell_v2.csv')
median_muni_raw <- read.csv('E:/R-code/Modeling/data/median_muni_v2.csv')
percentile5_muni_raw <- read.csv('E:/R-code/Modeling/data/percentile5_muni_v2.csv')
percentile95_muni_raw <- read.csv('E:/R-code/Modeling/data/percentile95_muni_v2.csv')
median_CARpoly_raw <- read.csv('E:/R-code/Modeling/data/median_CARpoly_v2.csv')
percentile5_CARpoly_raw <- read.csv('E:/R-code/Modeling/data/percentile5_CARpoly_v2.csv')
percentile95_CARpoly_raw <- read.csv('E:/R-code/Modeling/data/percentile95_CARpoly_v2.csv')
grid_1deg <- readOGR(dsn = 'E:/R-code/Modeling/data/shp/grid_1deg', layer = 'grid_1deg')
munis <- readOGR(dsn = 'E:/R-code/Modeling/data/shp/munis', layer = 'munis_SHP')
crs(munis) <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
#cell_shp <- readOGR(dsn = 'E:/R-code/Modeling/data/shp/median_onset_cell', layer = 'median_onset_cell_SHP')
cell_sf <- st_read(dsn = 'E:/R-code/Modeling/data/shp/median_onset_cell', layer = 'median_onset_cell_SHP')
cell_sf_tidy <- cell_sf %>% tidy_by_intensity_plant("SC_plant", "DC_plant") %>%
tidy_by_intensity_delay("SC_delay", "DC_delay") %>%
dplyr::select(-c(SC_harvest, DC_harvest))
cell_sf_tidy$year_index <- cell_sf_tidy$year - 2003
library(spgwr) # spatially weighted regression
year_oi <- 2013
# filter for a specific year, then turn sf object into SPDF
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
cell_spdf_tidy_year <- as(cell_sf_tidy_year, 'Spatial')
#run GWR
#calculate kernel bandwidth (takes a long time)
GWRbandwidth <- gwr.sel(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt =TRUE)
#run the gwr model
gwr.model <- gwr(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt=GWRbandwidth, hatmatrix=TRUE, se.fit=TRUE)
#print the results of the model
gwr.model
# third, map the results
# HOW TO SELECT ONLY CERTAIN YEARS??? DO MODEL FOR SELECT YEAR?
results <-as.data.frame(gwr.model$SDF)
gwr.map <- cbind(cell_spdf_tidy_year, as.matrix(results))
# create tmap objects
map_localR2 <- tm_shape(gwr.map) +
tm_fill("localR2", n = 5, style = "quantile", title = paste("Local R2,", year_oi)) +
tm_layout(frame = FALSE, legend.text.size = 0.5, legend.title.size = 0.6)
map_onset <- tm_shape(gwr.map) + tm_fill("onset.1", n = 5, style = "quantile", title = paste("Onset Coefficient,", year_oi)) +
tm_layout(frame = FALSE, legend.text.size = 0.5, legend.title.size = 0.6)
map_intensity <- tm_shape(gwr.map) + tm_fill("intensitySC", n = 5, style = "quantile", title = paste("Intensity Coefficient,", year_oi)) +
tm_layout(frame = FALSE, legend.text.size = 0.5, legend.title.size = 0.6)
map_latitude <- tm_shape(gwr.map) + tm_fill("lat.1", n = 5, style = "quantile", title = paste("Year Coefficient,", year_oi)) +
tm_layout(frame = FALSE, legend.text.size = 0.5, legend.title.size = 0.6)
map_localR2
map_onset
map_intensity
map_latitude
map_localR2 <- tm_shape(gwr.map) +
tm_fill("localR2", n = 5, style = "quantile") +
tm_layout(title = title = paste("Local R2,", year_oi))
tm_layout(frame = FALSE, legend.text.size = 0.5, legend.title.size = 0.6)
map_localR2
map_localR2 <- tm_shape(gwr.map) +
tm_fill("localR2", n = 5, style = "quantile") +
tm_layout(title = title = paste("Local R2,", year_oi), legend.text.size = 1.5, legend.title.size = 2)
map_localR2 <- tm_shape(gwr.map) +
tm_fill("localR2", n = 5, style = "quantile") +
tm_layout(title = paste("Local R2,", year_oi), legend.text.size = 1.5, legend.title.size = 2)
map_localR2
tm_shape(gwr.map) +
tm_fill("localR2", n = 5, style = "quantile") +
tm_layout(title = paste("Local R2,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
tm_shape(gwr.map) +
tm_fill(n = 5, style = "quantile") +
tm_layout(title = paste("Local R2,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
library(spgwr) # spatially weighted regression
year_oi <- 2013
# filter for a specific year, then turn sf object into SPDF
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
cell_spdf_tidy_year <- as(cell_sf_tidy_year, 'Spatial')
#run GWR
#calculate kernel bandwidth (takes a long time)
GWRbandwidth <- gwr.sel(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt =TRUE)
tm_shape(gwr.map) +
tm_fill("localR2", n = 5, style = "quantile") +
tm_layout(title = paste("Local R2,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
tm_shape(gwr.map) +
tm_fill("onset.1", n = 5, style = "quantile") +
tm_layout(title = paste("Onset Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
tm_shape(gwr.map) +
tm_fill("onset", n = 5, style = "quantile") +
tm_layout(title = paste("Onset Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
tm_shape(gwr.map) +
tm_fill("intensitySC", n = 5, style = "quantile") +
tm_layout(title = paste("IntensitySC Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
tm_shape(gwr.map) +
tm_fill("lat.1", n = 5, style = "quantile") +
tm_layout(title = paste("Latitude Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
names(gwr.map@data)
tm_shape(gwr.map) +
tm_fill("onset_se", n = 5, style = "quantile") +
tm_layout(title = paste("Onset Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
tm_shape(gwr.map) +
tm_fill("intensitySC_se", n = 5, style = "quantile") +
tm_layout(title = paste("IntensitySC Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
tm_shape(gwr.map) +
tm_fill("lat_se", n = 5, style = "quantile") +
tm_layout(title = paste("Latitude Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
year_oi <- 2010
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
# filter a specific year
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
nb <- poly2nb(cell_sf_tidy_year)
lw <- nb2listw(nb, zero.policy = TRUE)
# spatial lag model ---------------------------------------------------------------------
model_lag = lagsarlm(plant ~ onset + intensity + lat + onset:intensity, data=cell_sf_tidy_year, lw, tol.solve=1.0e-30,
zero.policy = TRUE)
summary(model_lag)
cell_sf_tidy_year$residuals_lag <- residuals(model_lag)
nb <- poly2nb(cell_sf_tidy_year)
resnb <- sapply(nb, function(x) mean(cell_sf_tidy_year$residuals_lag[x]))
cor(cell_sf_tidy_year$residuals, resnb)
plot(cell_sf_tidy_year$residuals, resnb, xlab='Residuals', ylab='Mean adjacent residuals', main = paste("Spatial lag,", year_oi))
lw <- nb2listw(nb, zero.policy = TRUE)
moran_basic_ols <- moran.mc(cell_sf_tidy_year$residuals, lw, 999, zero.policy = TRUE)
ggplot(cell_sf_tidy_year) +
geom_sf(aes(fill = residuals_lag)) +
scale_fill_viridis() +
ggtitle(paste("Residuals for spatial lag model,", year_oi)) +
theme_bw()
# spatial error model ---------------------------------------------------------------------
model_error = errorsarlm(plant ~ onset + intensity + lat + onset:intensity, data=cell_sf_tidy_year, lw, tol.solve=1.0e-30,
zero.policy = TRUE)
summary(model_error)
cell_sf_tidy_year$residuals_error <- residuals(model_error)
nb <- poly2nb(cell_sf_tidy_year)
resnb <- sapply(nb, function(x) mean(cell_sf_tidy_year$residuals_error[x]))
cor(cell_sf_tidy_year$residuals_error, resnb)
plot(cell_sf_tidy_year$residuals_error, resnb, xlab='Residuals', ylab='Mean adjacent residuals', main = paste("Spatial error,", year_oi))
lw <- nb2listw(nb, zero.policy = TRUE)
moran_basic_ols <- moran.mc(cell_sf_tidy_year$residuals_error, lw, 999, zero.policy = TRUE)
ggplot(cell_sf_tidy_year) +
geom_sf(aes(fill = residuals_error)) +
scale_fill_viridis() +
ggtitle(paste("Residuals for spatial error model,", year_oi)) +
theme_bw()
# test basic OLS for one year only (to be compared to spatial lag and spatial error) ----------------------------
year_oi <- 2010
# filter a specific year
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
model_ols <- lm(plant ~ onset + intensity + lat + onset:intensity, data=cell_sf_tidy_year)
summary(model_ols)
cell_sf_tidy_year$residuals <- residuals(model_ols)
ggplot(cell_sf_tidy_year) +
geom_sf(aes(fill = residuals)) +
scale_fill_viridis() +
ggtitle(paste("Residuals for basic OLS,", year_oi)) +
theme_bw()
nb <- poly2nb(cell_sf_tidy_year)
resnb <- sapply(nb, function(x) mean(cell_sf_tidy_year$residuals[x]))
plot(cell_sf_tidy_year$residuals, resnb, xlab='Residuals', ylab='Mean adjacent residuals', main = paste("Basic OLS,", year_oi))
lw <- nb2listw(nb, zero.policy = TRUE)
moran_basic_ols <- moran.mc(cell_sf_tidy_year$residuals, lw, 999, zero.policy = TRUE)
print('moran with basic ols, one year')
print(moran_basic_ols)
year_oi <- 2010
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
# filter a specific year
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
nb <- poly2nb(cell_sf_tidy_year)
lw <- nb2listw(nb, zero.policy = TRUE)
# spatial lag model ---------------------------------------------------------------------
model_lag = lagsarlm(plant ~ onset + intensity + lat + onset:intensity, data=cell_sf_tidy_year, lw, tol.solve=1.0e-30,
zero.policy = TRUE)
summary(model_lag)
cell_sf_tidy_year$residuals_lag <- residuals(model_lag)
nb <- poly2nb(cell_sf_tidy_year)
resnb <- sapply(nb, function(x) mean(cell_sf_tidy_year$residuals_lag[x]))
cor(cell_sf_tidy_year$residuals, resnb)
plot(cell_sf_tidy_year$residuals, resnb, xlab='Residuals', ylab='Mean adjacent residuals', main = paste("Spatial lag,", year_oi))
lw <- nb2listw(nb, zero.policy = TRUE)
moran_basic_ols <- moran.mc(cell_sf_tidy_year$residuals, lw, 999, zero.policy = TRUE)
ggplot(cell_sf_tidy_year) +
geom_sf(aes(fill = residuals_lag)) +
scale_fill_viridis() +
ggtitle(paste("Residuals for spatial lag model,", year_oi)) +
theme_bw()
# spatial error model ---------------------------------------------------------------------
model_error = errorsarlm(plant ~ onset + intensity + lat + onset:intensity, data=cell_sf_tidy_year, lw, tol.solve=1.0e-30,
zero.policy = TRUE)
summary(model_error)
cell_sf_tidy_year$residuals_error <- residuals(model_error)
nb <- poly2nb(cell_sf_tidy_year)
resnb <- sapply(nb, function(x) mean(cell_sf_tidy_year$residuals_error[x]))
cor(cell_sf_tidy_year$residuals_error, resnb)
plot(cell_sf_tidy_year$residuals_error, resnb, xlab='Residuals', ylab='Mean adjacent residuals', main = paste("Spatial error,", year_oi))
lw <- nb2listw(nb, zero.policy = TRUE)
moran_basic_ols <- moran.mc(cell_sf_tidy_year$residuals_error, lw, 999, zero.policy = TRUE)
ggplot(cell_sf_tidy_year) +
geom_sf(aes(fill = residuals_error)) +
scale_fill_viridis() +
ggtitle(paste("Residuals for spatial error model,", year_oi)) +
theme_bw()
moan_basic_ols
moran_basic_ols
year_oi <- 2010
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
# filter a specific year
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
nb <- poly2nb(cell_sf_tidy_year)
lw <- nb2listw(nb, zero.policy = TRUE)
# spatial lag model ---------------------------------------------------------------------
model_lag = lagsarlm(plant ~ onset + intensity + lat + onset:intensity, data=cell_sf_tidy_year, lw, tol.solve=1.0e-30,
zero.policy = TRUE)
summary(model_lag)
cell_sf_tidy_year$residuals_lag <- residuals(model_lag)
nb <- poly2nb(cell_sf_tidy_year)
resnb <- sapply(nb, function(x) mean(cell_sf_tidy_year$residuals_lag[x]))
plot(cell_sf_tidy_year$residuals_lag, resnb, xlab='Residuals', ylab='Mean adjacent residuals', main = paste("Spatial lag,", year_oi))
lw <- nb2listw(nb, zero.policy = TRUE)
moran_lag <- moran.mc(cell_sf_tidy_year$residuals_lag, lw, 999, zero.policy = TRUE)
moran_lag
ggplot(cell_sf_tidy_year) +
geom_sf(aes(fill = residuals_lag)) +
scale_fill_viridis() +
ggtitle(paste("Residuals for spatial lag model,", year_oi)) +
theme_bw()
# spatial error model ---------------------------------------------------------------------
model_error = errorsarlm(plant ~ onset + intensity + lat + onset:intensity, data=cell_sf_tidy_year, lw, tol.solve=1.0e-30,
zero.policy = TRUE)
summary(model_error)
cell_sf_tidy_year$residuals_error <- residuals(model_error)
nb <- poly2nb(cell_sf_tidy_year)
resnb <- sapply(nb, function(x) mean(cell_sf_tidy_year$residuals_error[x]))
plot(cell_sf_tidy_year$residuals_error, resnb, xlab='Residuals', ylab='Mean adjacent residuals', main = paste("Spatial error,", year_oi))
lw <- nb2listw(nb, zero.policy = TRUE)
moran_error <- moran.mc(cell_sf_tidy_year$residuals_error, lw, 999, zero.policy = TRUE)
moran_error
ggplot(cell_sf_tidy_year) +
geom_sf(aes(fill = residuals_error)) +
scale_fill_viridis() +
ggtitle(paste("Residuals for spatial error model,", year_oi)) +
theme_bw()
library(spgwr) # spatially weighted regression
year_oi <- 2010
# filter for a specific year, then turn sf object into SPDF
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
cell_spdf_tidy_year <- as(cell_sf_tidy_year, 'Spatial')
#run GWR
#calculate kernel bandwidth (takes a long time)
GWRbandwidth <- gwr.sel(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt =TRUE)
#run the gwr model
gwr.model <- gwr(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt=GWRbandwidth, hatmatrix=TRUE, se.fit=TRUE)
#print the results of the model
gwr.model
# third, map the results
results <-as.data.frame(gwr.model$SDF)
gwr.map <- cbind(cell_spdf_tidy_year, as.matrix(results))
# create tmap objects
map_localR2 <- tm_shape(gwr.map) +
tm_fill("localR2", n = 5, style = "quantile") +
tm_layout(title = paste("Local R2,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_onset <- tm_shape(gwr.map) +
tm_fill("onset.1", n = 5, style = "quantile") +
tm_layout(title = paste("Onset Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_intensity <- tm_shape(gwr.map) +
tm_fill("intensitySC", n = 5, style = "quantile") +
tm_layout(title = paste("IntensitySC Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_latitude <- tm_shape(gwr.map) +
tm_fill("lat.1", n = 5, style = "quantile") +
tm_layout(title = paste("Latitude Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_onset_se <- tm_shape(gwr.map) +
tm_fill("onset_se", n = 5, style = "quantile") +
tm_layout(title = paste("Onset Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_intensity_se <- tm_shape(gwr.map) +
tm_fill("intensitySC_se", n = 5, style = "quantile") +
tm_layout(title = paste("IntensitySC Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_latitude_se <- tm_shape(gwr.map) +
tm_fill("lat_se", n = 5, style = "quantile") +
tm_layout(title = paste("Latitude Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_localR2
map_onset
map_intensity
map_latitude
map_onset_se
map_intensity_se
map_latitude_se
# test basic OLS for one year only (to be compared to spatial lag and spatial error) ----------------------------
year_oi <- 2008
# filter a specific year
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
model_ols <- lm(plant ~ onset + intensity + lat + onset:intensity, data=cell_sf_tidy_year)
summary(model_ols)
cell_sf_tidy_year$residuals <- residuals(model_ols)
ggplot(cell_sf_tidy_year) +
geom_sf(aes(fill = residuals)) +
scale_fill_viridis() +
ggtitle(paste("Residuals for basic OLS,", year_oi)) +
theme_bw()
nb <- poly2nb(cell_sf_tidy_year)
resnb <- sapply(nb, function(x) mean(cell_sf_tidy_year$residuals[x]))
plot(cell_sf_tidy_year$residuals, resnb, xlab='Residuals', ylab='Mean adjacent residuals', main = paste("Basic OLS,", year_oi))
lw <- nb2listw(nb, zero.policy = TRUE)
moran_basic_ols <- moran.mc(cell_sf_tidy_year$residuals, lw, 999, zero.policy = TRUE)
print('moran with basic ols, one year')
print(moran_basic_ols)
year_oi <- 2008
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
# filter a specific year
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
nb <- poly2nb(cell_sf_tidy_year)
lw <- nb2listw(nb, zero.policy = TRUE)
# spatial lag model ---------------------------------------------------------------------
model_lag = lagsarlm(plant ~ onset + intensity + lat + onset:intensity, data=cell_sf_tidy_year, lw, tol.solve=1.0e-30,
zero.policy = TRUE)
summary(model_lag)
cell_sf_tidy_year$residuals_lag <- residuals(model_lag)
nb <- poly2nb(cell_sf_tidy_year)
resnb <- sapply(nb, function(x) mean(cell_sf_tidy_year$residuals_lag[x]))
plot(cell_sf_tidy_year$residuals_lag, resnb, xlab='Residuals', ylab='Mean adjacent residuals', main = paste("Spatial lag,", year_oi))
lw <- nb2listw(nb, zero.policy = TRUE)
moran_lag <- moran.mc(cell_sf_tidy_year$residuals_lag, lw, 999, zero.policy = TRUE)
moran_lag
ggplot(cell_sf_tidy_year) +
geom_sf(aes(fill = residuals_lag)) +
scale_fill_viridis() +
ggtitle(paste("Residuals for spatial lag model,", year_oi)) +
theme_bw()
# spatial error model ---------------------------------------------------------------------
model_error = errorsarlm(plant ~ onset + intensity + lat + onset:intensity, data=cell_sf_tidy_year, lw, tol.solve=1.0e-30,
zero.policy = TRUE)
summary(model_error)
cell_sf_tidy_year$residuals_error <- residuals(model_error)
nb <- poly2nb(cell_sf_tidy_year)
resnb <- sapply(nb, function(x) mean(cell_sf_tidy_year$residuals_error[x]))
plot(cell_sf_tidy_year$residuals_error, resnb, xlab='Residuals', ylab='Mean adjacent residuals', main = paste("Spatial error,", year_oi))
lw <- nb2listw(nb, zero.policy = TRUE)
moran_error <- moran.mc(cell_sf_tidy_year$residuals_error, lw, 999, zero.policy = TRUE)
moran_error
ggplot(cell_sf_tidy_year) +
geom_sf(aes(fill = residuals_error)) +
scale_fill_viridis() +
ggtitle(paste("Residuals for spatial error model,", year_oi)) +
theme_bw()
library(spgwr) # spatially weighted regression
year_oi <- 2008
# filter for a specific year, then turn sf object into SPDF
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
cell_spdf_tidy_year <- as(cell_sf_tidy_year, 'Spatial')
#run GWR
#calculate kernel bandwidth (takes a long time)
GWRbandwidth <- gwr.sel(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt =TRUE)
#run the gwr model
gwr.model <- gwr(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt=GWRbandwidth, hatmatrix=TRUE, se.fit=TRUE)
#print the results of the model
gwr.model
# third, map the results
results <-as.data.frame(gwr.model$SDF)
gwr.map <- cbind(cell_spdf_tidy_year, as.matrix(results))
# create tmap objects
map_localR2 <- tm_shape(gwr.map) +
tm_fill("localR2", n = 5, style = "quantile") +
tm_layout(title = paste("Local R2,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_onset <- tm_shape(gwr.map) +
tm_fill("onset.1", n = 5, style = "quantile") +
tm_layout(title = paste("Onset Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_intensity <- tm_shape(gwr.map) +
tm_fill("intensitySC", n = 5, style = "quantile") +
tm_layout(title = paste("IntensitySC Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_latitude <- tm_shape(gwr.map) +
tm_fill("lat.1", n = 5, style = "quantile") +
tm_layout(title = paste("Latitude Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_onset_se <- tm_shape(gwr.map) +
tm_fill("onset_se", n = 5, style = "quantile") +
tm_layout(title = paste("Onset Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_intensity_se <- tm_shape(gwr.map) +
tm_fill("intensitySC_se", n = 5, style = "quantile") +
tm_layout(title = paste("IntensitySC Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_latitude_se <- tm_shape(gwr.map) +
tm_fill("lat_se", n = 5, style = "quantile") +
tm_layout(title = paste("Latitude Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_localR2
map_onset
map_intensity
map_latitude
map_onset_se
map_intensity_se
map_latitude_se
# test basic OLS for one year only (to be compared to spatial lag and spatial error) ----------------------------
year_oi <- 2005
# filter a specific year
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
model_ols <- lm(plant ~ onset + intensity + lat + onset:intensity, data=cell_sf_tidy_year)
summary(model_ols)
cell_sf_tidy_year$residuals <- residuals(model_ols)
ggplot(cell_sf_tidy_year) +
geom_sf(aes(fill = residuals)) +
scale_fill_viridis() +
ggtitle(paste("Residuals for basic OLS,", year_oi)) +
theme_bw()
nb <- poly2nb(cell_sf_tidy_year)
resnb <- sapply(nb, function(x) mean(cell_sf_tidy_year$residuals[x]))
plot(cell_sf_tidy_year$residuals, resnb, xlab='Residuals', ylab='Mean adjacent residuals', main = paste("Basic OLS,", year_oi))
lw <- nb2listw(nb, zero.policy = TRUE)
moran_basic_ols <- moran.mc(cell_sf_tidy_year$residuals, lw, 999, zero.policy = TRUE)
print('moran with basic ols, one year')
print(moran_basic_ols)
# test basic OLS for one year only (to be compared to spatial lag and spatial error) ----------------------------
year_oi <- 2006
# filter a specific year
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
model_ols <- lm(plant ~ onset + intensity + lat + onset:intensity, data=cell_sf_tidy_year)
summary(model_ols)
cell_sf_tidy_year$residuals <- residuals(model_ols)
ggplot(cell_sf_tidy_year) +
geom_sf(aes(fill = residuals)) +
scale_fill_viridis() +
ggtitle(paste("Residuals for basic OLS,", year_oi)) +
theme_bw()
nb <- poly2nb(cell_sf_tidy_year)
resnb <- sapply(nb, function(x) mean(cell_sf_tidy_year$residuals[x]))
plot(cell_sf_tidy_year$residuals, resnb, xlab='Residuals', ylab='Mean adjacent residuals', main = paste("Basic OLS,", year_oi))
lw <- nb2listw(nb, zero.policy = TRUE)
moran_basic_ols <- moran.mc(cell_sf_tidy_year$residuals, lw, 999, zero.policy = TRUE)
print('moran with basic ols, one year')
print(moran_basic_ols)
year_oi <- 2006
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
# filter a specific year
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
nb <- poly2nb(cell_sf_tidy_year)
lw <- nb2listw(nb, zero.policy = TRUE)
# spatial lag model ---------------------------------------------------------------------
model_lag = lagsarlm(plant ~ onset + intensity + lat + onset:intensity, data=cell_sf_tidy_year, lw, tol.solve=1.0e-30,
zero.policy = TRUE)
summary(model_lag)
cell_sf_tidy_year$residuals_lag <- residuals(model_lag)
nb <- poly2nb(cell_sf_tidy_year)
resnb <- sapply(nb, function(x) mean(cell_sf_tidy_year$residuals_lag[x]))
plot(cell_sf_tidy_year$residuals_lag, resnb, xlab='Residuals', ylab='Mean adjacent residuals', main = paste("Spatial lag,", year_oi))
lw <- nb2listw(nb, zero.policy = TRUE)
moran_lag <- moran.mc(cell_sf_tidy_year$residuals_lag, lw, 999, zero.policy = TRUE)
moran_lag
ggplot(cell_sf_tidy_year) +
geom_sf(aes(fill = residuals_lag)) +
scale_fill_viridis() +
ggtitle(paste("Residuals for spatial lag model,", year_oi)) +
theme_bw()
# spatial error model ---------------------------------------------------------------------
model_error = errorsarlm(plant ~ onset + intensity + lat + onset:intensity, data=cell_sf_tidy_year, lw, tol.solve=1.0e-30,
zero.policy = TRUE)
summary(model_error)
cell_sf_tidy_year$residuals_error <- residuals(model_error)
nb <- poly2nb(cell_sf_tidy_year)
resnb <- sapply(nb, function(x) mean(cell_sf_tidy_year$residuals_error[x]))
plot(cell_sf_tidy_year$residuals_error, resnb, xlab='Residuals', ylab='Mean adjacent residuals', main = paste("Spatial error,", year_oi))
lw <- nb2listw(nb, zero.policy = TRUE)
moran_error <- moran.mc(cell_sf_tidy_year$residuals_error, lw, 999, zero.policy = TRUE)
moran_error
ggplot(cell_sf_tidy_year) +
geom_sf(aes(fill = residuals_error)) +
scale_fill_viridis() +
ggtitle(paste("Residuals for spatial error model,", year_oi)) +
theme_bw()
library(spgwr) # spatially weighted regression
year_oi <- 2006
# filter for a specific year, then turn sf object into SPDF
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
cell_sf_tidy_year <- cell_sf_tidy %>% filter(year == year_oi)
cell_spdf_tidy_year <- as(cell_sf_tidy_year, 'Spatial')
#run GWR
#calculate kernel bandwidth (takes a long time)
GWRbandwidth <- gwr.sel(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt =TRUE)
#run the gwr model
gwr.model <- gwr(plant ~ onset + intensity + lat + onset:intensity,
data = cell_spdf_tidy_year, adapt=GWRbandwidth, hatmatrix=TRUE, se.fit=TRUE)
#print the results of the model
gwr.model
# third, map the results
results <-as.data.frame(gwr.model$SDF)
gwr.map <- cbind(cell_spdf_tidy_year, as.matrix(results))
# create tmap objects
map_localR2 <- tm_shape(gwr.map) +
tm_fill("localR2", n = 5, style = "quantile") +
tm_layout(title = paste("Local R2,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_onset <- tm_shape(gwr.map) +
tm_fill("onset.1", n = 5, style = "quantile") +
tm_layout(title = paste("Onset Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_intensity <- tm_shape(gwr.map) +
tm_fill("intensitySC", n = 5, style = "quantile") +
tm_layout(title = paste("IntensitySC Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_latitude <- tm_shape(gwr.map) +
tm_fill("lat.1", n = 5, style = "quantile") +
tm_layout(title = paste("Latitude Coefficient,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_onset_se <- tm_shape(gwr.map) +
tm_fill("onset_se", n = 5, style = "quantile") +
tm_layout(title = paste("Onset Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_intensity_se <- tm_shape(gwr.map) +
tm_fill("intensitySC_se", n = 5, style = "quantile") +
tm_layout(title = paste("IntensitySC Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_latitude_se <- tm_shape(gwr.map) +
tm_fill("lat_se", n = 5, style = "quantile") +
tm_layout(title = paste("Latitude Coef Std Error,", year_oi), legend.text.size = 0.5, legend.title.size = 1)
map_localR2
map_onset
map_intensity
map_latitude
map_onset_se
map_intensity_se
map_latitude_se
